<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.omg.org/bpmn20" xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:bpsim="http://www.bpsim.org/schemas/1.0" xmlns:color="http://www.omg.org/spec/BPMN/non-normative/color" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:drools="http://www.jboss.org/drools" id="_AqdeAEDIEeiWbLGirsQIiA" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd http://www.jboss.org/drools drools.xsd http://www.bpsim.org/schemas/1.0 bpsim.xsd" exporter="jBPM Designer" exporterVersion="6.2.0" expressionLanguage="http://www.mvel.org/2.0" targetNamespace="http://www.omg.org/bpmn20" typeLanguage="http://www.java.com/javaTypes">
  <bpmn2:itemDefinition id="_IsRequestInProgressItem" structureRef="Boolean"/>
  <bpmn2:itemDefinition id="_PGORRequestObjItem" structureRef="kocfdunit.kocfdproject.kocfdpackage.PGORRequestDO"/>
  <bpmn2:itemDefinition id="_actionItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_workflowidItem" structureRef="Integer"/>
  <bpmn2:itemDefinition id="_workflownameItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_wellidItem" structureRef="Integer"/>
  <bpmn2:itemDefinition id="_wellnameItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_fieldidItem" structureRef="Integer"/>
  <bpmn2:itemDefinition id="_fieldItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_gcidItem" structureRef="Integer"/>
  <bpmn2:itemDefinition id="_gcItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_engineerItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_welltypeItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_priorityItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_targetdateItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_instancejsonItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_usernameItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_IsRequestProcessedItem" structureRef="Boolean"/>
  <bpmn2:itemDefinition id="_IterationNrItem" structureRef="Integer"/>
  <bpmn2:itemDefinition id="_emailbodyItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_emailfromItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_emailtoItem" structureRef="String"/>
  <bpmn2:itemDefinition id="_emailsubjectItem" structureRef="String"/>
  <bpmn2:process id="KOCFDProject.PGORRequest" drools:packageName="org.jbpm" drools:version="1.0.0.1" name="PGORRequest" isExecutable="true">
    <bpmn2:property id="IsRequestInProgress" itemSubjectRef="_IsRequestInProgressItem"/>
    <bpmn2:property id="PGORRequestObj" itemSubjectRef="_PGORRequestObjItem"/>
    <bpmn2:property id="action" itemSubjectRef="_actionItem"/>
    <bpmn2:property id="workflowid" itemSubjectRef="_workflowidItem"/>
    <bpmn2:property id="workflowname" itemSubjectRef="_workflownameItem"/>
    <bpmn2:property id="wellid" itemSubjectRef="_wellidItem"/>
    <bpmn2:property id="wellname" itemSubjectRef="_wellnameItem"/>
    <bpmn2:property id="fieldid" itemSubjectRef="_fieldidItem"/>
    <bpmn2:property id="field" itemSubjectRef="_fieldItem"/>
    <bpmn2:property id="gcid" itemSubjectRef="_gcidItem"/>
    <bpmn2:property id="gc" itemSubjectRef="_gcItem"/>
    <bpmn2:property id="engineer" itemSubjectRef="_engineerItem"/>
    <bpmn2:property id="welltype" itemSubjectRef="_welltypeItem"/>
    <bpmn2:property id="priority" itemSubjectRef="_priorityItem"/>
    <bpmn2:property id="targetdate" itemSubjectRef="_targetdateItem"/>
    <bpmn2:property id="instancejson" itemSubjectRef="_instancejsonItem"/>
    <bpmn2:property id="username" itemSubjectRef="_usernameItem"/>
    <bpmn2:property id="IsRequestProcessed" itemSubjectRef="_IsRequestProcessedItem"/>
    <bpmn2:property id="IterationNr" itemSubjectRef="_IterationNrItem"/>
    <bpmn2:property id="emailbody" itemSubjectRef="_emailbodyItem"/>
    <bpmn2:property id="emailfrom" itemSubjectRef="_emailfromItem"/>
    <bpmn2:property id="emailto" itemSubjectRef="_emailtoItem"/>
    <bpmn2:property id="emailsubject" itemSubjectRef="_emailsubjectItem"/>
    <bpmn2:startEvent id="_35442782-34B4-44E0-8F90-0596BCE6CBE1" drools:selectable="true" color:background-color="#9acd32" color:border-color="#000000" color:color="#000000" name="">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:outgoing>_3053D7FC-CB96-4E05-8D82-46501E6798C0</bpmn2:outgoing>
    </bpmn2:startEvent>
    <bpmn2:endEvent id="_25101E45-29F9-4C3C-8AF3-0D9150417C62" drools:selectable="true" color:background-color="#ff6347" color:border-color="#000000" color:color="#000000" name="">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_A6B57DC6-AA55-473E-A852-E41EB84DA603</bpmn2:incoming>
    </bpmn2:endEvent>
    <bpmn2:scriptTask id="_E3BDBB90-7FD2-42F1-8296-90893BFCF9CF" drools:selectable="true" color:background-color="#fafad2" color:border-color="#000000" color:color="#000000" name="Create Request" scriptFormat="http://www.java.com/java">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[Create Request]]></drools:metaValue>
        </drools:metaData>
        <drools:onExit-script scriptFormat="http://www.java.com/java">
          <drools:script><![CDATA[kcontext.setVariable("emailsubject","This is the Subject");
kcontext.setVariable("emailto","Ram.Vellanki@gmail.com");
kcontext.setVariable("emailfrom","Ram.Vellanki@gmail.com");
kcontext.setVariable("emailbody","This is just a body");


]]></drools:script>
        </drools:onExit-script>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_3053D7FC-CB96-4E05-8D82-46501E6798C0</bpmn2:incoming>
      <bpmn2:outgoing>_B217FDC7-905E-4C7E-861B-68C464B32E58</bpmn2:outgoing>
      <bpmn2:script><![CDATA[System.out.println("***PGOR REQUEST INIT START***");
try
{
	kocfdunit.kocfdproject.kocfdpackage.PGORRequestDO Ticket = new kocfdunit.kocfdproject.kocfdpackage.PGORRequestDO();
	String workflowinstanceid;
	String JSONString;
	String PostTicketUrl;
	String get_ticket_url;
	String ticketId = null;
	String TicketDetails;

	Ticket.setAction(kcontext.getVariable("action")!=null?kcontext.getVariable("action").toString():"");
	Ticket.setEngineer(kcontext.getVariable("engineer")!=null?kcontext.getVariable("engineer").toString():"");
	Ticket.setField(kcontext.getVariable("field")!=null?kcontext.getVariable("field").toString():"");
	Ticket.setFieldid(kcontext.getVariable("fieldid")!=null?kcontext.getVariable("fieldid").toString():"");
	Ticket.setGc(kcontext.getVariable("gc")!=null?kcontext.getVariable("gc").toString():"");
	Ticket.setGcid(kcontext.getVariable("gcid")!=null?kcontext.getVariable("gcid").toString():"");
	//Ticket.setWorkFlowCategory(kcontext.getVariable("workflowname")!=null?kcontext.getVariable("workflowname").toString():"");
	Ticket.setPriority(kcontext.getVariable("priority")!=null?kcontext.getVariable("priority").toString():"");
	Ticket.setWell(kcontext.getVariable("wellname")!=null?kcontext.getVariable("wellname").toString():"");
	Ticket.setWellType(kcontext.getVariable("welltype")!=null?kcontext.getVariable("welltype").toString():"");
	Ticket.setWellid(kcontext.getVariable("wellid")!=null?Integer.parseInt(kcontext.getVariable("wellid").toString()):null);
	if(kcontext.getVariable("targetdate") !=null)
	{
		java.util.Date date1=new java.text.SimpleDateFormat("dd/MM/yyyy").parse(kcontext.getVariable("targetdate").toString());
		Ticket.setTargetdate(date1);
	}
	else
	{
		Ticket.setTargetdate(null);
	}

	kcontext.setVariable("PGORRequestObj",Ticket);
	workflowinstanceid= Long.toString(kcontext.getProcessInstance().getId());

	com.google.gson.GsonBuilder gsonBuilder = new com.google.gson.GsonBuilder();
	gsonBuilder.disableHtmlEscaping();
	com.google.gson.Gson gson = gsonBuilder.create();
	//com.google.gson.Gson gson = new com.google.gson.Gson();

	
	com.google.gson.JsonObject Ticketdetailsjson = new com.google.gson.JsonObject();	
	Ticketdetailsjson.addProperty("gc",kcontext.getVariable("gc").toString());
	Ticketdetailsjson.addProperty("field",kcontext.getVariable("field").toString());
	Ticketdetailsjson.addProperty("workflowname",kcontext.getVariable("workflowname").toString());
	Ticketdetailsjson.addProperty("priority",kcontext.getVariable("priority").toString());
	Ticketdetailsjson.addProperty("wellname",kcontext.getVariable("wellname").toString());
	Ticketdetailsjson.addProperty("welltype",kcontext.getVariable("welltype").toString());
	Ticketdetailsjson.addProperty("targetdate",kcontext.getVariable("targetdate").toString());

    System.out.println("*** NO PROBLEM TILL THIS POINT ***");
	
	//Ticketdetailsjson.addProperty("fieldid",kcontext.getVariable("fieldid").toString());
	//Ticketdetailsjson.addProperty("gcid",kcontext.getVariable("gcid").toString());
	//Ticketdetailsjson.addProperty("wellid",kcontext.getVariable("wellid").toString());
	////System.out.println("jsontaskvariable" + gson.toJson(jsontaskvariable));

	String jsonInString = Ticketdetailsjson.toString();
	System.out.println("Ticketdetailsjson before encoding" + jsonInString);
	jsonInString= java.net.URLEncoder.encode(jsonInString,"UTF-8");
	System.out.println("Ticketdetailsjson after encoding" + jsonInString);

	get_ticket_url="http://192.168.1.60:8080/dsdataserver/dsl.svc/VM_KWIDFBPM/1/FDWorkFlow/ALL_PROJECTS/SP_CREATETICKET?workflowinstanceid="+ workflowinstanceid + "&workflowid=1&description='Test'&createdby='" + kcontext.getVariable("initiator")+"'&priority='" + kcontext.getVariable("priority").toString()+"'&targetdate='"+ kcontext.getVariable("targetdate")+" 00:00:00'&ticketdetails='" +jsonInString+"'" ;
	//get_ticket_url="http://192.168.1.60:8080/dsdataserver/dsl.svc/VM_KWIDFBPM/1/FDWorkFlow/ALL_PROJECTS/SP_CREATERequest?workflowinstanceid="+ workflowinstanceid + "&workflowid=1&description='Test'&createdby='" + kcontext.getVariable("initiator")+"'&priority='" + kcontext.getVariable("priority").toString()+"'&targetdate='"+ kcontext.getVariable("targetdate")+" 00:00:00'&Ticketdetails='" +jsonInString+"'" ;
	System.out.println("get_ticket_url" + get_ticket_url);

	javax.ws.rs.client.Client client = javax.ws.rs.client.ClientBuilder.newClient().register(new javax.ws.rs.client.ClientRequestFilter() {
	  private final String user = "admin";
      private final String password = "admin";
	
      public void filter(javax.ws.rs.client.ClientRequestContext requestContext) throws java.io.IOException {
        javax.ws.rs.core.MultivaluedMap<String, Object> headers = requestContext.getHeaders();
          final String basicAuthentication = getBasicAuthentication();
          headers.add("Authorization", basicAuthentication);
      }
  
      private String getBasicAuthentication() {
          String token = this.user + ":" + this.password;
          try {
			  return "BASIC " + javax.xml.bind.DatatypeConverter.printBase64Binary(token.getBytes("UTF-8"));
          } catch (java.io.UnsupportedEncodingException ex) {
              throw new java.lang.IllegalStateException("Cannot encode with UTF-8", ex);
          }
      }
  });


	System.out.println("get PGOR Request details --------------");
	try
	{
	javax.ws.rs.client.WebTarget wr = client.target(get_ticket_url);
	String strResponse = wr.request(javax.ws.rs.core.MediaType.APPLICATION_JSON).get(String.class);
		
		if(strResponse != null) {
			System.out.println("get_Ticket_url_response" + strResponse);
		}
	}
	catch(java.lang.Exception e){
		System.out.println("Error saving BPM state informtion in DSIS");
		System.out.println(e);
	}
}
catch(java.lang.Exception e)
{
	System.out.println("Error saving BPM state INIT");
	System.out.println(e);
}
System.out.println("***PGOR REQUEST INIT FINISH***");
]]></bpmn2:script>
    </bpmn2:scriptTask>
    <bpmn2:sequenceFlow id="_3053D7FC-CB96-4E05-8D82-46501E6798C0" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_35442782-34B4-44E0-8F90-0596BCE6CBE1" targetRef="_E3BDBB90-7FD2-42F1-8296-90893BFCF9CF"/>
    <bpmn2:scriptTask id="_E079CE35-104E-4617-A09B-F90D2C732259" drools:selectable="true" color:background-color="#fafad2" color:border-color="#000000" color:color="#000000" name="verify" scriptFormat="http://www.java.com/java">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[verify]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_E9FA4594-0FDA-4900-8586-6064787DB850</bpmn2:incoming>
      <bpmn2:outgoing>_7CBF32DB-73F0-4610-A95D-25A32CEE213D</bpmn2:outgoing>
      <bpmn2:script><![CDATA[System.out.println("***PGOR REQUEST INIT START***");]]></bpmn2:script>
    </bpmn2:scriptTask>
    <bpmn2:exclusiveGateway id="_6EA41697-2F3A-4581-97BF-39A0142D5693" drools:selectable="true" drools:dg="" color:background-color="#f0e68c" color:border-color="#a67f00" color:color="#000000" name="Verify Check" gatewayDirection="Diverging">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[Verify Check]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_BF462583-4BC7-42EA-A855-73CF998567AC</bpmn2:incoming>
      <bpmn2:outgoing>_3B4B7A4C-95D8-40BC-B467-8BE7A21CBA98</bpmn2:outgoing>
      <bpmn2:outgoing>_E15FFB34-45D6-4C9B-909E-F7F9CF8CD5F9</bpmn2:outgoing>
    </bpmn2:exclusiveGateway>
    <bpmn2:sequenceFlow id="_3B4B7A4C-95D8-40BC-B467-8BE7A21CBA98" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_6EA41697-2F3A-4581-97BF-39A0142D5693" targetRef="_69FDF869-30B1-42C8-A7D0-4E2A7C963217">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression" id="_Aqmn8EDIEeiWbLGirsQIiA" language="http://www.java.com/java"><![CDATA[return  KieFunctions.isTrue(IsRequestProcessed);]]></bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>
    <bpmn2:exclusiveGateway id="_4E51FA27-EACD-451B-BD81-49F797569108" drools:selectable="true" drools:dg="" color:background-color="#f0e68c" color:border-color="#a67f00" color:color="#000000" name="Verify and Create" gatewayDirection="Converging">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[Verify and Create]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_DC7C5A7C-0C15-4A21-B6F7-273E78549515</bpmn2:incoming>
      <bpmn2:incoming>_B217FDC7-905E-4C7E-861B-68C464B32E58</bpmn2:incoming>
      <bpmn2:outgoing>_E9FA4594-0FDA-4900-8586-6064787DB850</bpmn2:outgoing>
    </bpmn2:exclusiveGateway>
    <bpmn2:sequenceFlow id="_E15FFB34-45D6-4C9B-909E-F7F9CF8CD5F9" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_6EA41697-2F3A-4581-97BF-39A0142D5693" targetRef="_FC5B233D-B592-4829-AD3A-F26F4F1C5815">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression" id="_Aqmn8UDIEeiWbLGirsQIiA" language="http://www.java.com/java"><![CDATA[return  IsRequestProcessed == null || KieFunctions.isFalse(IsRequestProcessed);]]></bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>
    <bpmn2:sequenceFlow id="_E9FA4594-0FDA-4900-8586-6064787DB850" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_4E51FA27-EACD-451B-BD81-49F797569108" targetRef="_E079CE35-104E-4617-A09B-F90D2C732259"/>
    <bpmn2:intermediateCatchEvent id="_B2132ADA-FB02-4DB5-86DD-FC217EC010D6" drools:selectable="true" drools:boundaryca="true" color:background-color="#f5deb3" color:border-color="#a0522d" color:color="#000000" name="">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_7CBF32DB-73F0-4610-A95D-25A32CEE213D</bpmn2:incoming>
      <bpmn2:outgoing>_BF462583-4BC7-42EA-A855-73CF998567AC</bpmn2:outgoing>
      <bpmn2:timerEventDefinition id="_Aqmn8kDIEeiWbLGirsQIiA">
        <bpmn2:timeCycle xsi:type="bpmn2:tFormalExpression" id="_Aqmn80DIEeiWbLGirsQIiA">20s</bpmn2:timeCycle>
      </bpmn2:timerEventDefinition>
    </bpmn2:intermediateCatchEvent>
    <bpmn2:sequenceFlow id="_7CBF32DB-73F0-4610-A95D-25A32CEE213D" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_E079CE35-104E-4617-A09B-F90D2C732259" targetRef="_B2132ADA-FB02-4DB5-86DD-FC217EC010D6"/>
    <bpmn2:sequenceFlow id="_BF462583-4BC7-42EA-A855-73CF998567AC" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_B2132ADA-FB02-4DB5-86DD-FC217EC010D6" targetRef="_6EA41697-2F3A-4581-97BF-39A0142D5693"/>
    <bpmn2:scriptTask id="_FC5B233D-B592-4829-AD3A-F26F4F1C5815" drools:selectable="true" color:background-color="#fafad2" color:border-color="#000000" color:color="#000000" name="Test Scr" scriptFormat="http://www.java.com/java">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[Test Scr]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_E15FFB34-45D6-4C9B-909E-F7F9CF8CD5F9</bpmn2:incoming>
      <bpmn2:outgoing>_DC7C5A7C-0C15-4A21-B6F7-273E78549515</bpmn2:outgoing>
      <bpmn2:script><![CDATA[System.out.println("***NOT YET FINISHED***");

//The logic below is to check for 3 times and close the ticket; this will be replaced with the VDB call to check for the status of the request.

int iIterationNr = 0;

iIterationNr = kcontext.getVariable("IterationNr")!=null?
  Integer.parseInt(kcontext.getVariable("IterationNr").toString()) : 0;

kcontext.setVariable("IterationNr",iIterationNr+1);
System.out.println("Iteration: " + iIterationNr);

if (iIterationNr > 3)
{
  kcontext.setVariable("IsRequestProcessed", true);
}]]></bpmn2:script>
    </bpmn2:scriptTask>
    <bpmn2:sequenceFlow id="_DC7C5A7C-0C15-4A21-B6F7-273E78549515" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_FC5B233D-B592-4829-AD3A-F26F4F1C5815" targetRef="_4E51FA27-EACD-451B-BD81-49F797569108"/>
    <bpmn2:scriptTask id="_69FDF869-30B1-42C8-A7D0-4E2A7C963217" drools:selectable="true" color:background-color="#fafad2" color:border-color="#000000" color:color="#000000" name="Close Ticket" scriptFormat="http://www.java.com/java">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue><![CDATA[Close Ticket]]></drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>_3B4B7A4C-95D8-40BC-B467-8BE7A21CBA98</bpmn2:incoming>
      <bpmn2:outgoing>_A6B57DC6-AA55-473E-A852-E41EB84DA603</bpmn2:outgoing>
      <bpmn2:script><![CDATA[System.out.println("PGOR REQUEST CLOSEOUT - BEGIN");
String temp_dsis_url = null;
String get_ticket_url=null;
String workflowinstanceid ;
String getReqResponse;
String ticketid=null;
String taskid=null;

String ticket_state_url = "http://192.168.1.60:8080/dsdataserver/dsl.svc/VM_KWIDFBPM/1/FDWorkFlow/ALL_PROJECTS/SP_COMPLETESTAGE";
workflowinstanceid= Long.toString(kcontext.getProcessInstance().getId());
get_ticket_url= "http://192.168.1.60:8080/dsdataserver/dsl.svc/VM_KWIDFBPM/1/FDWorkFlow/ALL_PROJECTS/VW_GetTicketDetails?$filter=workflowinstanceid eq " + workflowinstanceid;
System.out.println("get_ticket_url" + get_ticket_url);

javax.ws.rs.client.Client client = javax.ws.rs.client.ClientBuilder.newClient().register(new javax.ws.rs.client.ClientRequestFilter() {
	  private final String user = "admin";
      private final String password = "admin";
	
      public void filter(javax.ws.rs.client.ClientRequestContext requestContext) throws java.io.IOException {
        javax.ws.rs.core.MultivaluedMap<String, Object> headers = requestContext.getHeaders();
          final String basicAuthentication = getBasicAuthentication();
          headers.add("Authorization", basicAuthentication);
      }
  
      private String getBasicAuthentication() {
          String token = this.user + ":" + this.password;
          try {
			  return "BASIC " + javax.xml.bind.DatatypeConverter.printBase64Binary(token.getBytes("UTF-8"));
          } catch (java.io.UnsupportedEncodingException ex) {
              throw new java.lang.IllegalStateException("Cannot encode with UTF-8", ex);
          }
      }
  });

try {
	//dsis URL is set in the previous script task. So it will always be available in this task. Do not have to read from config file if null.
	//temp_dsis_url = kcontext.getKnowledgeRuntime().getGlobal("dsis_url").toString();
		
	//getReqResponse=response.toString();
	System.out.println("get ticket details --------------");
	javax.ws.rs.client.WebTarget wr = client.target(get_ticket_url);

    String strResponse = wr.request(javax.ws.rs.core.MediaType.APPLICATION_JSON).get(String.class);
    
	if(strResponse != null) {
		com.google.gson.JsonObject jsonObject = null;
		com.google.gson.JsonParser jsonParser = new com.google.gson.JsonParser();
		jsonObject = (com.google.gson.JsonObject) jsonParser.parse(strResponse);            
		if(jsonObject.getAsJsonArray("value").size() > 0) {
			com.google.gson.JsonObject jasonObjectValue = null;
			jasonObjectValue = (com.google.gson.JsonObject)jsonObject.getAsJsonArray("value").get(0);
			ticketid = jasonObjectValue.get("ticketid").toString();
			//getAsString();                                            
			//kcontext.setVariable("task_list",temp_task_list);
			System.out.println("RESPONSE - FROM DSIS GET TICKET DETAILS " + ticketid);
		}
	}


	if(ticketid !="" && ticketid!=null) {
		System.out.println("CLOSE OUT START");	
		ticket_state_url="http://192.168.1.60:8080/dsdataserver/dsl.svc/VM_KWIDFBPM/1/FDWorkFlow/ALL_PROJECTS/SP_CLOSETICKET?ticketid="+ ticketid +"&ticketstatecomments='" + "Automated Close" +"'&createdby='" + "admin"+"'&ticketstage='PGOR Request'"+ "&ticketstate='PGOR Request Complete'";
		System.out.println(ticket_state_url);

		try{
			wr = client.target(ticket_state_url);
			strResponse = wr.request(javax.ws.rs.core.MediaType.APPLICATION_JSON).get(String.class);
			if(strResponse != null) 
			{
				 System.out.println("PGOR Request CLOSE Completed");
			}
		}
		catch(java.lang.Exception e)
		{
			System.out.println("Error saving BPM state informtion in DSIS (PGOR Request Closeout)");
			System.out.println(e);
		}
	}
} 
catch (java.lang.Exception e) {
	System.out.println("Error saving BPM state informtion in DSIS");
	System.out.println(e);
}
System.out.println("PGOR REQUEST CLOSEOUT - END");]]></bpmn2:script>
    </bpmn2:scriptTask>
    <bpmn2:sequenceFlow id="_A6B57DC6-AA55-473E-A852-E41EB84DA603" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_69FDF869-30B1-42C8-A7D0-4E2A7C963217" targetRef="_25101E45-29F9-4C3C-8AF3-0D9150417C62"/>
    <bpmn2:sequenceFlow id="_B217FDC7-905E-4C7E-861B-68C464B32E58" drools:selectable="true" color:background-color="#000000" color:border-color="#000000" color:color="#000000" sourceRef="_E3BDBB90-7FD2-42F1-8296-90893BFCF9CF" targetRef="_4E51FA27-EACD-451B-BD81-49F797569108"/>
  </bpmn2:process>
  <bpmndi:BPMNDiagram id="_Aqmn9EDIEeiWbLGirsQIiA">
    <bpmndi:BPMNPlane id="_Aqmn9UDIEeiWbLGirsQIiA" bpmnElement="KOCFDProject.PGORRequest">
      <bpmndi:BPMNShape id="_Aqmn9kDIEeiWbLGirsQIiA" bpmnElement="_35442782-34B4-44E0-8F90-0596BCE6CBE1">
        <dc:Bounds height="30.0" width="30.0" x="18.0" y="189.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn90DIEeiWbLGirsQIiA" bpmnElement="_25101E45-29F9-4C3C-8AF3-0D9150417C62">
        <dc:Bounds height="28.0" width="28.0" x="763.0" y="189.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn-EDIEeiWbLGirsQIiA" bpmnElement="_E3BDBB90-7FD2-42F1-8296-90893BFCF9CF">
        <dc:Bounds height="68.0" width="93.0" x="75.0" y="165.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn-UDIEeiWbLGirsQIiA" bpmnElement="_E079CE35-104E-4617-A09B-F90D2C732259">
        <dc:Bounds height="80.0" width="100.0" x="244.0" y="163.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn-kDIEeiWbLGirsQIiA" bpmnElement="_6EA41697-2F3A-4581-97BF-39A0142D5693">
        <dc:Bounds height="40.0" width="40.0" x="450.0" y="183.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn-0DIEeiWbLGirsQIiA" bpmnElement="_4E51FA27-EACD-451B-BD81-49F797569108">
        <dc:Bounds height="40.0" width="40.0" x="197.0" y="65.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn_EDIEeiWbLGirsQIiA" bpmnElement="_B2132ADA-FB02-4DB5-86DD-FC217EC010D6">
        <dc:Bounds height="30.0" width="30.0" x="388.0" y="188.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn_UDIEeiWbLGirsQIiA" bpmnElement="_FC5B233D-B592-4829-AD3A-F26F4F1C5815">
        <dc:Bounds height="80.0" width="100.0" x="418.0" y="45.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="_Aqmn_kDIEeiWbLGirsQIiA" bpmnElement="_69FDF869-30B1-42C8-A7D0-4E2A7C963217">
        <dc:Bounds height="80.0" width="100.0" x="585.0" y="163.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="_Aqmn_0DIEeiWbLGirsQIiA" bpmnElement="_3053D7FC-CB96-4E05-8D82-46501E6798C0" sourceElement="_Aqmn9kDIEeiWbLGirsQIiA" targetElement="_Aqmn-EDIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="33.0" y="204.0"/>
        <di:waypoint xsi:type="dc:Point" x="121.5" y="199.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoAEDIEeiWbLGirsQIiA" bpmnElement="_3B4B7A4C-95D8-40BC-B467-8BE7A21CBA98" sourceElement="_Aqmn-kDIEeiWbLGirsQIiA" targetElement="_Aqmn_kDIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="470.0" y="203.0"/>
        <di:waypoint xsi:type="dc:Point" x="635.0" y="203.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoAUDIEeiWbLGirsQIiA" bpmnElement="_E15FFB34-45D6-4C9B-909E-F7F9CF8CD5F9" sourceElement="_Aqmn-kDIEeiWbLGirsQIiA" targetElement="_Aqmn_UDIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="470.0" y="203.0"/>
        <di:waypoint xsi:type="dc:Point" x="468.0" y="85.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoAkDIEeiWbLGirsQIiA" bpmnElement="_E9FA4594-0FDA-4900-8586-6064787DB850" sourceElement="_Aqmn-0DIEeiWbLGirsQIiA" targetElement="_Aqmn-UDIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="217.0" y="85.0"/>
        <di:waypoint xsi:type="dc:Point" x="217.0" y="203.0"/>
        <di:waypoint xsi:type="dc:Point" x="294.0" y="203.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoA0DIEeiWbLGirsQIiA" bpmnElement="_7CBF32DB-73F0-4610-A95D-25A32CEE213D" sourceElement="_Aqmn-UDIEeiWbLGirsQIiA" targetElement="_Aqmn_EDIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="294.0" y="203.0"/>
        <di:waypoint xsi:type="dc:Point" x="403.0" y="203.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoBEDIEeiWbLGirsQIiA" bpmnElement="_BF462583-4BC7-42EA-A855-73CF998567AC" sourceElement="_Aqmn_EDIEeiWbLGirsQIiA" targetElement="_Aqmn-kDIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="403.0" y="203.0"/>
        <di:waypoint xsi:type="dc:Point" x="470.0" y="203.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoBUDIEeiWbLGirsQIiA" bpmnElement="_DC7C5A7C-0C15-4A21-B6F7-273E78549515" sourceElement="_Aqmn_UDIEeiWbLGirsQIiA" targetElement="_Aqmn-0DIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="468.0" y="85.0"/>
        <di:waypoint xsi:type="dc:Point" x="217.0" y="85.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoBkDIEeiWbLGirsQIiA" bpmnElement="_A6B57DC6-AA55-473E-A852-E41EB84DA603" sourceElement="_Aqmn_kDIEeiWbLGirsQIiA" targetElement="_Aqmn90DIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="635.0" y="203.0"/>
        <di:waypoint xsi:type="dc:Point" x="777.0" y="203.0"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="_AqmoB0DIEeiWbLGirsQIiA" bpmnElement="_B217FDC7-905E-4C7E-861B-68C464B32E58" sourceElement="_Aqmn-EDIEeiWbLGirsQIiA" targetElement="_Aqmn-0DIEeiWbLGirsQIiA">
        <di:waypoint xsi:type="dc:Point" x="121.5" y="199.0"/>
        <di:waypoint xsi:type="dc:Point" x="121.0" y="85.0"/>
        <di:waypoint xsi:type="dc:Point" x="217.0" y="85.0"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
  <bpmn2:relationship id="_AqmoCEDIEeiWbLGirsQIiA" type="BPSimData">
    <bpmn2:extensionElements>
      <bpsim:BPSimData>
        <bpsim:Scenario xsi:type="bpsim:Scenario" id="default" name="Simulationscenario">
          <bpsim:ScenarioParameters xsi:type="bpsim:ScenarioParameters" baseTimeUnit="min"/>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_BF462583-4BC7-42EA-A855-73CF998567AC" id="_AqmoCUDIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_E15FFB34-45D6-4C9B-909E-F7F9CF8CD5F9" id="_AqmoCkDIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_3B4B7A4C-95D8-40BC-B467-8BE7A21CBA98" id="_AqmoC0DIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_FC5B233D-B592-4829-AD3A-F26F4F1C5815" id="_AqmoDEDIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:CostParameters xsi:type="bpsim:CostParameters">
              <bpsim:UnitCost xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="0.0"/>
              </bpsim:UnitCost>
            </bpsim:CostParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_69FDF869-30B1-42C8-A7D0-4E2A7C963217" id="_AqmoDUDIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:CostParameters xsi:type="bpsim:CostParameters">
              <bpsim:UnitCost xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="0.0"/>
              </bpsim:UnitCost>
            </bpsim:CostParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_7CBF32DB-73F0-4610-A95D-25A32CEE213D" id="_AqmoDkDIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_E3BDBB90-7FD2-42F1-8296-90893BFCF9CF" id="_AqmoD0DIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:CostParameters xsi:type="bpsim:CostParameters">
              <bpsim:UnitCost xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="0.0"/>
              </bpsim:UnitCost>
            </bpsim:CostParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_B2132ADA-FB02-4DB5-86DD-FC217EC010D6" id="_AqmoEEDIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_E9FA4594-0FDA-4900-8586-6064787DB850" id="_AqmoEUDIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_25101E45-29F9-4C3C-8AF3-0D9150417C62" id="_AqmoEkDIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_A6B57DC6-AA55-473E-A852-E41EB84DA603" id="_AqmoE0DIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_35442782-34B4-44E0-8F90-0596BCE6CBE1" id="_AqmoFEDIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_DC7C5A7C-0C15-4A21-B6F7-273E78549515" id="_AqmoFUDIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_B217FDC7-905E-4C7E-861B-68C464B32E58" id="_AqmoFkDIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_3053D7FC-CB96-4E05-8D82-46501E6798C0" id="_AqmoF0DIEeiWbLGirsQIiA">
            <bpsim:ControlParameters xsi:type="bpsim:ControlParameters">
              <bpsim:Probability xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="100.0"/>
              </bpsim:Probability>
            </bpsim:ControlParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters xsi:type="bpsim:ElementParameters" elementRef="_E079CE35-104E-4617-A09B-F90D2C732259" id="_AqmoGEDIEeiWbLGirsQIiA">
            <bpsim:TimeParameters xsi:type="bpsim:TimeParameters">
              <bpsim:ProcessingTime xsi:type="bpsim:Parameter">
                <bpsim:UniformDistribution max="10.0" min="5.0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:CostParameters xsi:type="bpsim:CostParameters">
              <bpsim:UnitCost xsi:type="bpsim:Parameter">
                <bpsim:FloatingParameter value="0.0"/>
              </bpsim:UnitCost>
            </bpsim:CostParameters>
          </bpsim:ElementParameters>
        </bpsim:Scenario>
      </bpsim:BPSimData>
    </bpmn2:extensionElements>
    <bpmn2:source>_AqdeAEDIEeiWbLGirsQIiA</bpmn2:source>
    <bpmn2:target>_AqdeAEDIEeiWbLGirsQIiA</bpmn2:target>
  </bpmn2:relationship>
</bpmn2:definitions>
